{% extends 'public_base.html' %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-6">
    <h2 class="h5 mb-3">Assinatura do contrato</h2>
    <p class="small text-muted mb-1">Reserva #{{ booking.id }}</p>
    <p class="small text-muted mb-3">
      Hóspede: <strong>{{ booking.guest.name }}</strong><br>
      Período: {{ booking.check_in.strftime('%d/%m/%Y') }} até {{ booking.check_out.strftime('%d/%m/%Y') }}
    </p>
    <p>Assine diretamente na tela com o dedo (celular) ou com o mouse.</p>

    <form method="post" class="mt-3" onsubmit="return prepareSignature()">
      <div class="mb-3">
        <label class="form-label d-block">Sua assinatura</label>
        <div class="border rounded bg-white" style="touch-action: none;">
          <canvas id="sigpad" style="width: 100%; height: 200px; display: block;"></canvas>
        </div>
        <div class="d-flex justify-content-between mt-2">
          <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearSignature()">Limpar</button>
          <span class="small text-muted">Faça a assinatura completa dentro do quadro.</span>
        </div>
      </div>

      <input type="hidden" name="signature_data" id="signature_data">

      <div class="mb-3">
        <p class="small text-muted mb-1">
          Se tiver dificuldade para assinar na tela, fale com o anfitrião para combinar outra forma de assinatura.
        </p>
      </div>

      <button class="btn btn-primary w-100">Enviar assinatura</button>
    </form>

    <p class="mt-3 small text-muted">
      Ao enviar, você declara que leu e concorda com o contrato recebido
      e autoriza o uso desta assinatura para fins de locação desta hospedagem.
    </p>
  </div>
</div>

<script>
(function() {
  const canvas = document.getElementById('sigpad');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  let drawing = false;
  let lastX = 0;
  let lastY = 0;
  let hasStroke = false;

  function resizeCanvas() {
    const rect = canvas.getBoundingClientRect();
    // Salva o conteúdo atual ao redimensionar (simples: aqui apenas limpa)
    canvas.width = rect.width;
    canvas.height = 200;
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.strokeStyle = '#000000';
  }

  function getPos(e) {
    if (e.touches && e.touches.length > 0) {
      const rect = canvas.getBoundingClientRect();
      return {
        x: e.touches[0].clientX - rect.left,
        y: e.touches[0].clientY - rect.top
      };
    } else {
      const rect = canvas.getBoundingClientRect();
      return {
        x: e.clientX - rect.left,
        y: e.clientY - rect.top
      };
    }
  }

  function startDraw(e) {
    e.preventDefault();
    const pos = getPos(e);
    drawing = true;
    hasStroke = true;
    lastX = pos.x;
    lastY = pos.y;
  }

  function moveDraw(e) {
    if (!drawing) return;
    e.preventDefault();
    const pos = getPos(e);
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(pos.x, pos.y);
    ctx.stroke();
    lastX = pos.x;
    lastY = pos.y;
  }

  function endDraw(e) {
    if (!drawing) return;
    e.preventDefault();
    drawing = false;
  }

  function clearSignature() {
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    hasStroke = false;
  }

  window.clearSignature = clearSignature;

  function prepareSignature() {
    if (!hasStroke) {
      alert('Por favor, faça a sua assinatura dentro do quadro.');
      return false;
    }
    const dataUrl = canvas.toDataURL('image/png');
    document.getElementById('signature_data').value = dataUrl;
    return true;
  }

  window.prepareSignature = prepareSignature;

  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();

  canvas.addEventListener('mousedown', startDraw);
  canvas.addEventListener('mousemove', moveDraw);
  canvas.addEventListener('mouseup', endDraw);
  canvas.addEventListener('mouseleave', endDraw);

  canvas.addEventListener('touchstart', startDraw, {passive: false});
  canvas.addEventListener('touchmove', moveDraw, {passive: false});
  canvas.addEventListener('touchend', endDraw, {passive: false});
})();
</script>
{% endblock %}
